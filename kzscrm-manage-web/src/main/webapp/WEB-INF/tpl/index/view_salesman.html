<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>新增业务员</title>
    <link rel="stylesheet" href="$!rc.contextPath/static/css/bootstrap/bootstrap.css">
    <link rel="stylesheet" href="$!rc.contextPath/static/css/font-awesome/font-awesome.min.css">
    <link rel="stylesheet" href="$!rc.contextPath/static/css/common.css">
    <link rel="stylesheet" href="$!rc.contextPath/static/css/style.css">
    <link rel="stylesheet" href="$!rc.contextPath/static/css/style2.css">
</head>
<body>
<form class="form-horizontal add-merchants" id="form" name="form" enctype="multipart/form-data" action="$!rc.contextPath/crmbusiness/doSave" method="post">
    <!-- <input type="hidden" name="id" value="$!canteenId" /> -->
    <input type="hidden" name="businessId" value="$!cBusinessVO.id" />
    <div class="form-group">
        <div class="col-sm-3 text-right">
            <label class="control-label" for="cname">姓名</label>
        </div>
        <div class="col-sm-5">
            <input class="form-control" name="name" placeholder="请输入姓名" value="$!cBusinessVO.name" datatype="*" nullmsg="姓名不能为空" sucmsg=" "/>
        </div>
        <div class="col-sm-3">                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
            <div class="Validform_checktip"></div>
        </div>
    </div>
   
    <div class="form-group" id="team">
        <div class="col-sm-3 text-right">
            <label class="control-label" for="ctype">所属团队</label>
        </div>
        <div class="col-sm-5 has-feedback">
              <select class="form-control" name="teamId" id="teamId" datatype="*" nullmsg="请选择团队" sucmsg=" " errormsg="请选择团队" onchange="teamChange(this)">
	                    <option value="">请选择</option>
						#foreach($!team in $!crmTeamPOs)                    
	                    	<option #if($!cBusinessVO.teamId==$!team.id)  selected="selected" #end  value="$!team.id">$!team.name</option>
	                	#end
	                </select>
            <i class="fa fa-sort-down form-control-feedback triangle-fa"></i>
        </div>
        <div class="col-sm-3">
            <div class="Validform_checktip"></div>
        </div>
    </div>
    <div class="form-group">
        <div class="col-sm-3 text-right">
            <label class="control-label" for="ctype">角色</label>
        </div>
        <div class="col-sm-5 has-feedback">
            <select class="form-control selectarrow" id="roleId" name="roleId" datatype="*" nullmsg="请选择角色" sucmsg=" " onchange="roleChange(this)">
                <option selected="selected" value="">请选择</option>
                #foreach($!crmPermRolePO in $!crmPermRolePOs)
                	<option #if($!crmPermRolePO.id==$!cBusinessVO.roleId)  selected #end  value="$!crmPermRolePO.id" userType="$!crmPermRolePO.userType">$!crmPermRolePO.name</option>
				#end                
            </select>
            <i class="fa fa-sort-down form-control-feedback triangle-fa"></i>
        </div>
        <div class="col-sm-3">
            <div class="Validform_checktip"></div>
        </div>
    </div>
    <div class="form-group">
        <div class="col-sm-3 text-right">
            <label class="control-label" for="ctype">岗位职务</label>
        </div>
        <div class="col-sm-5 has-feedback">
            <select class="form-control selectarrow" name="positionId" datatype="*" nullmsg="请选择岗位职务" sucmsg=" ">
                <option selected="selected" value="">请选择</option>
                #foreach($!position in $!crmPositionPOs)
                	<option #if($!position.id==$!cBusinessVO.positionId)  selected="selected" #end  value="$!position.id">$!position.name</option>
				#end                
            </select>
            <i class="fa fa-sort-down form-control-feedback triangle-fa"></i>
        </div>
        <div class="col-sm-3">
            <div class="Validform_checktip"></div>
        </div>
    </div>
    <div class="form-group">
        <div class="col-sm-3 text-right">
            <label class="control-label" for="ctel">身份证号码</label>
        </div>
        <div class="col-sm-5">
            <input class="form-control" name="headIdcard" placeholder="请输入身份证号码" value="$!cBusinessVO.headIdCard" datatype="n15-18" nullmsg="身份证号不能为空" errormsg="身份证号格式不正确" sucmsg=" "/>
        </div>
        <div class="col-sm-3">
            <div class="Validform_checktip"></div>
        </div>
    </div>
    <div class="form-group mobilephone">
        <div class="col-sm-3 text-right">
            <label class="control-label" for="cpho">联系电话</label>
        </div>
        <div class="col-sm-5">
            <input class="form-control" id="mobilephone" name="mobilephone" onchange="changePhone()" placeholder="请输入联系电话" value="$!cBusinessVO.mobilephone" datatype="n11" nullmsg="手机号码不能为空" errormsg="手机号码格式不正确" sucmsg=" ">
        </div>
        <div class="col-sm-3">
            <div class="Validform_checktip"></div>
        </div>
    </div>
    <div class="form-group">
        <div class="col-sm-3 text-right">
            <label class="control-label" for="cpho">微信号</label>
        </div>
        <div class="col-sm-5">
            <input class="form-control" name="weixin" placeholder="请输入微信号" value="$!cBusinessVO.weixin"/>
        </div>
        <div class="col-sm-3">
            <div class="Validform_checktip"></div>
        </div>
    </div>
    <div class="text-center mt40 pr">
    	
        <a class="btn btn-warning save crmBusinessUpDate" href="javascript:void(0);" onclick="">编辑保存</a>
    </div>
</form>

<script src="$!rc.contextPath/static/js/jquery/jquery-1.11.1.min.js"></script>
<script src="$!rc.contextPath/static/js/jquery/jquery-extend.js"></script>
<script src="$!rc.contextPath/static/js/bootstrap/bootstrap.min.js"></script>
<script src="$!rc.contextPath/static/js/layer/layer.js"></script>
<script src="$!rc.contextPath/static/js/ValidForm/Validform_v5.3.2.js"></script>
<script type="text/javascript">

    /* 表单验证 */
    $('.save').click(function() {
        if ($('.Validform_checktip').hasClass('.Validform_wrong')) {
            $(this).prev().css('display', 'block');
        }
    });
    var validForm = $('.form-horizontal').Validform({
        btnSubmit : ".save",
        tiptype : 2,
        datatype : {
            "zh2-10" : /^[\u4E00-\u9FA5\uf900-\ufa2d]{2,10}$/,
            "zn" : /^[\u4E00-\u9FA50-9]+$/,
            "n11" : /^(13[0-9]|14[5|7]|15[0|1|2|3|5|6|7|8|9]|17[0|1|3|5|6|7|8]|18[0|1|2|3|5|6|7|8|9])\d{8}$/,
            "dn11" : /^\d{3}-\d{8}|\d{4}-\d{7}$/,
            "nd":/^[0-9-]{8,}$/,
            "wn" : /^[a-zA-Z\d_]{5,}$/,
            "n15-18":/^(\d{15}$|^\d{18}$|^\d{17}(\d|X|x))$/,
            'select':/^[1-9]$/
        },
        postonce : true,
        ignoreHidden:true,
        ajaxPost : true,
        beforeCheck:function(){
            /* var prov=$('.prov').val(),
                city=$('.city').val(),
                dist=$('.dist').val(),
                textarea=$('textarea').val(),
                showInfo=$('.geography .Validform_checktip');
            if(prov != '' && city != ''  && city != null && dist != '' && dist != null && textarea != ''){
                showInfo.addClass('Validform_right');
            }else if(prov == '' && city == null && dist == null && textarea == ''){
                showInfo.addClass('Validform_wrong');
                showInfo.text('地理信息不能为空');
            }else{
                showInfo.text('地理信息不完善');
            } */
            return true;
        },
        callback : function(data) {
            if (data.code == 0) {
                $('.save').prev().css('display', 'none');
                parent.$("table").bootstrapTable('refresh');
                parent.layer.closeAll();
                parent.layer.msg("修改成功!");
            } else {
                layer.msg(data.desc);
                $('.save').prev().css('display', 'none');
            }
        }
    });
    var postData=$("#from").serialize();
    validForm.config({
        showAllError:true,
        url:"$!rc.contextPath/crmbusiness/doUpdate",
        ajaxPost:{
            data:postData
        }
    });
    function roleChange(self){
    	//选择的是业务经理时，排除有业务经理的团队,否则显示所有团队
	    if($(self).find('option:selected[userType="4"]').length==1){
	    	$('#teamId').attr('disabled','disabled');
	    	$.postJson('/crmbusiness/getBusiness',{type:1},function(data){
		    	if(data.code==0){
			    	$('#teamId').attr('disabled',null);
			    	//找出有业务经理的团队
			    	var businessManagerOfTeamId=new Set();
					if(data.rows.length>=1){
						//查找已有业务经理的团队
						$.each(data.rows,function(index,item){
							if(item.userType==2){
								if(item.teamId){
									businessManagerOfTeamId.add(item.teamId);
								}
							}
						});
						//如果找到了，就遍历，如果在所属团队中找到了，就隐藏，否则展示
						if(businessManagerOfTeamId.size>0){
							$.each($('#team option:not(:first)'),function(index,item){
								if(businessManagerOfTeamId.has(parseInt($(item).attr('value')))){
									$(item).hide();
								}else{
									$(item).show();
								}
							});
						}
					}else{
						$('#team').find('option').show();
					}
				}else{
					layer.msg(data.desc)
				}
	    	})
	    }else{
	    	$('#team').find('option').show();
	    }
    }
    function teamChange(self){
    	$('#roleId').attr('disabled','disabled');//禁用角色
		$.postJson('/crmteam/getBusinessManager',{id:$('#teamId').val()},function(data){
			if(data.code==0){
		    	$('#roleId').attr('disabled',null);
				if(data.rows.length>=1){
					$('#roleId').find('option[userType="4"]').hide();
				}else{
					$('#roleId').find('option[userType="4"]').show();
				}
			}else{
				layer.msg(data.desc)
			}
    	})
    }

</script>
<script type="text/javascript">
	$(document).ready(function(){
		#foreach($!cSourcesVO in $!cSourcesVOs)
			#if(!$!cSourcesVO.check)
				$('$!cSourcesVO.frontContrlName').remove();
			#end
		#end
	})
	
</script>


</body>
</html>





