<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>修改密码</title>  
    <link rel="stylesheet" href="/static/css/font-awesome/font-awesome.min.css">  
    <link rel="stylesheet" href="/static/css/bootstrap/bootstrap.min.css">
    <link rel="stylesheet" href="/static/css/common.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <style>
    	.form-horizontal .form-group{
	    	margin-left: 0;
	    	margin-right: 0;
    	}
    </style>
</head>
<body>
	<div class="second-page-header">
        <div class="container">
            <h2><a href="$!rc.contextPath/index">筷子说单位版</a></h2>
            <h3>修改密码</h3>
        </div>    
    </div>
    <div class="second-page-bg">
        <div class="container second-page-body">
  	<form class="form-horizontal form-next" action="$!rc.contextPath/crmUser/validVerificationCode" style="margin-top: 50px;">
  		<div class="form-group">
			<div class="col-sm-2 col-sm-offset-2 text-right">
				<label class="control-label">角色选择</label>
			</div>
			<div class="col-sm-3 col-md-4 col-lg-3">
				<div class="has-feedback" style="display: inline-block;">
					<select class="form-control jurisdiction" id="roleSelect" name="userType" datatype="select" nullmsg="请选择角色" sucmsg=" " errormsg="角色选择有误">
	                    <option value="">请选择权限</option>
	                    <option value=1>管理员</option>
	                    <option value=2>代理商</option>
	                    <option value=3>业务员</option>
	                    <option value=4>业务经理</option>
	                </select>
	                <i class="fa fa-sort-down form-control-feedback triangle-fa"></i>
				</div>
			</div>
			<div class="col-sm-3 pl0">
				<div style="display: inline-block;">
					<div class="Validform_checktip"></div>
				</div>
			</div>
		</div>
		<div class="form-group">
			<div class="col-sm-2 col-sm-offset-2 text-right">
				<label class="control-label">登录账号</label>
			</div>
			<div class="col-sm-5 col-md-4 col-lg-3">
				<input class="form-control" id="mobilephone" datatype="mobilephone" nullmsg="帐号不能为空" errormsg="帐号格式不正确" sucmsg=" " name="mobilephone" placeholder="请输入登录账号"/>	
			</div>
			<div class="col-sm-3 pl0">
                      <div class="Validform_checktip"></div>
                  </div>
		</div>
		<div class="form-group clearfix">
			<div class="col-sm-2 col-sm-offset-2 text-right">
				<label class="control-label">图片验证码</label>
			</div>
			<div class="col-sm-2">
      			<input class="form-control pull-left verification" id="imgCode" name="imgCode" placeholder="请输入验证码"/>
  			</div>
  			<div class="col-sm-3 pl0">
  				<img  class="pull-left valid-img" style="height:34px;" src="$!rc.contextPath/nl/getVerifyCode" onclick="this.src='$!rc.contextPath/nl/getVerifyCode?t='+new Date().getTime()">
  				<!-- <a class="pull-left ver-info" onclick="$(this).prev().attr('src', '$!rc.contextPath/nl/getVerifyCode?t='+new Date().getTime())">看不清换一张</a> -->
			</div>
		</div>
		<div class="form-group">
			<div class="col-sm-2 col-sm-offset-2 text-right">
				<label class="control-label">手机验证码</label>
			</div>
			<div class="col-sm-3 col-md-3 col-lg-3">
				<input class="form-control" name="smsCode" placeholder="请输入手机验证码" datatype="n6" nullmsg="验证码不能为空" errormsg="验证码格式不正确" sucmsg=" "/>
			</div>
			<div class="col-sm-5 col-md-4 pl0">
				<a class="btn btn-default pull-left width-auto" href="javascript:void(0);" onclick="sendMsg(this)">获取验证码</a>
				<div class="Validform_checktip pull-left ml15"></div>
			</div>
		</div>
		<div class="form-group">
			<div class="text-center mt40">
				<a class="btn btn-warning" id="change-next" href="javascript:void(0);">下一步</a>
			</div>
		</div>	
	</form>
	<form class="form-horizontal form-ok" action="$!rc.contextPath/crmUser/modifyPassword">
		<input type="hidden" name="userType" id="userTypeNext"/>
		<input type="hidden" name="mobilephone" id="mobilephoneNext"/>
		<div class="form-group">
			<div class="col-sm-2 col-sm-offset-2">
				<label class="control-label">新密码</label>
			</div>
			<div class="col-sm-5 col-md-4 col-lg-3">
				<input class="form-control first-input" id="psd" name="password" type="password" placeholder="请输入新密码（6-12位）" datatype="n6-12" nullmsg="密码不能为空" errormsg="密码格式不正确" sucmsg=" "/>
			</div>
			<div class="col-sm-3 pl0">
                      <div class="Validform_checktip"></div>
                  </div>
		</div>
		<div class="form-group">
			<div class="col-sm-2 col-sm-offset-2">
				<label class="control-label">新密码确认</label>
			</div>
			<div class="col-sm-5 col-md-4 col-lg-3">
				<input class="form-control" id="psd-again" name="confirmPassword" type="password" placeholder="请再次输入密码" recheck="password" datatype="*" nullmsg="密码确认不能为空" errormsg="两次密码不一致" sucmsg=" "/>
			</div>
			<div class="col-sm-3 pl0">
                      <div class="Validform_checktip"></div>
                  </div>
		</div>
		<div class="form-group">
			<div class="text-center mt40">
				<a class="btn btn-warning" id="change-true" href="javascript:void(0);">确定</a>
			</div>
		</div>	
	</form>
	<div class="reminder">
		<img src="$!rc.contextPath/static/images/u322.png"/>
		<p class="mt30">密码已更新，要记住哦</p>
	</div>
	</div></div>
	<script src="/static/js/jquery/jquery-1.11.1.min.js"></script>
	<script src="/static/js/ValidForm/Validform_v5.3.2.js"></script>
	<script src="/static/js/layer/layer.js"></script>
	<script src="/static/js/placeholder.js"></script>
	<script type="text/javascript">
		$(function(){
			$('.form-ok').hide();
			$('.reminder').hide();
		});

		/* 表单验证 */
		var validForm=$('.form-next').Validform({
            btnSubmit:"#change-next",
            tiptype:2,
            datatype:{
            	"n6":/^[0-9]{6}$/,
            	"mobilephone":/^[0-9]{11}$/,
            	"select":/^[0-9]{1}/
            },
            showAllError:true,
            contentType:'application/json;charset=UTF-8',
            postonce:true,
           	ajaxPost:true,
            callback:function(data){
            	if(data && data.code == 0){ 
	        	    $('.form-next').hide();
	    			$('.form-ok').show();
	    			//设置值到隐藏域
	    			$('#userTypeNext').val($('#roleSelect').val());
	    			$('#mobilephoneNext').val($('#mobilephone').val());
	    			
	        	}else{
	        		layer.msg(data.desc);
	        	}
            }
        });
		
		function sendMsg(obj) { //发送短信验证码
			var mobilephone = $('#mobilephone').val();
			var imgInput=$('#imgCode').val();
			if(imgInput==''||imgInput==null){
				return;
			}
	    	$.ajax({
		        url: "$!rc.contextPath/crmUser/moidfyPasswordVerificationCode",
		        type: 'post',
		        contentType:'application/json;charset=UTF-8;',
		        data: JSON.stringify({mobilephone: mobilephone,smsType:1}),
		        dataType: 'json',
		        error: function (data) {
		            layer.msg("数据异常!");
		        },
		        success: function (data) {
		            if (data.code == 0) {
		            	var timer=60;
		            	obj.setAttribute("disabled", true);
						obj.text="( " + timer +"秒后重新发送 )";
						
				    	var timerId=setInterval(function(){
				    		if(timer==0){
				    			obj.removeAttribute("disabled");
								obj.text="获取验证码";
								timer = 60;
								clearInterval(timerId);
				    		}else{
				    			obj.setAttribute("disabled", true);
								timer--;
								obj.text="( " + timer +"秒后重新发送 )";
				    		}
				    	},1000)
		            } else {
		                var desc = data.desc;
		                if (desc == null || desc == undefined) {
		                    desc = "超时或系统异常!";
		                }
		                layer.msg(desc);
		                obj.removeAttribute("disabled");
		            }
		        }
		    })
		}
		
		var validForm=$('.form-ok').Validform({
            btnSubmit:"#change-true",
            tiptype:2,
            datatype:{
                "n6-12":/^[a-zA-Z0-9_]{6,12}$/
            },
            showAllError:true,
            postonce:true,
           	ajaxPost:true,
            
            callback:function(data){
            	if(data && data.code == 0){
	        		$('.form-ok').hide();
	    			$('.reminder').show();
	    			setTimeout(function(){
	    				parent.layer.closeAll();
	    			})
	        	}else{
	        		layer.msg(data.desc);
	        	}
            }
        });
	</script>
</body>
</html>







